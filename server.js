import express from 'express';import cors from 'cors';import dotenv from 'dotenv';import {Client} from '@notionhq/client';import Anthropic from '@anthropic-ai/sdk';import axios from 'axios';dotenv.config();const app=express();app.use(cors());app.use(express.json());const notion=new Client({auth:process.env.NOTION_API_KEY});const anthropic=new Anthropic({apiKey:process.env.ANTHROPIC_API_KEY});async function extractContent(url){try{const response=await axios.get(url,{headers:{'User-Agent':'Mozilla/5.0'}});const text=response.data.replace(/<[^>]*>/g,' ').substring(0,3000);return text;}catch(error){return null;}}function detectContentType(url,fileName=''){const urlLower=url.toLowerCase();const fileNameLower=fileName.toLowerCase();if(urlLower.includes('youtube.com')||urlLower.includes('youtu.be')||urlLower.includes('vimeo.com')||urlLower.includes('podcast')||fileNameLower.includes('.mp3')||fileNameLower.includes('.m4a')){return 'PODCASTS';}if(fileNameLower.includes('.pdf')||urlLower.includes('pdf')){return 'BOOKS';}return 'ARTICLES';}async function generateSummary(content,contentType){try{const prompt=`Summarize this ${contentType.toLowerCase()}:\n${content}\n\nProvide: 1) A 2-3 sentence summary 2) 3-5 key takeaways as bullet points\n\nFormat:\nSUMMARY: [summary]\nKEY TAKEAWAYS:\n- [takeaway]`;const message=await anthropic.messages.create({model:'claude-3-5-sonnet-20241022',max_tokens:500,messages:[{role:'user',content:prompt}]});return message.content[0].text;}catch(error){return 'Summary failed.';}}function parseSummary(response){const summaryMatch=response.match(/SUMMARY:\s*(.+?)(?=KEY TAKEAWAYS:|$)/s);const takeawaysMatch=response.match(/KEY TAKEAWAYS:\s*([\s\S]+?)$/);const summary=summaryMatch?summaryMatch[1].trim():'';const takeaways=takeawaysMatch?takeawaysMatch[1].split('\n').filter(line=>line.trim().startsWith('-')).map(line=>line.replace(/^-\s*/,'')):[];return {summary,takeaways};}async function saveToNotion(data){try{const {title,url,contentType,summary,keyTakeaways}=data;const dbId=process.env[`NOTION_${contentType}_DB`];if(!dbId){throw new Error(`DB not found for ${contentType}`);}const response=await notion.pages.create({parent:{database_id:dbId},properties:{'Title':{title:[{text:{content:title||'Untitled'}}]},'URL':{url:url},'Summary':{rich_text:[{text:{content:summary||'No summary'}}]},'Key Takeaways':{rich_text:[{text:{content:keyTakeaways.join('\nâ€¢ ')||'No takeaways'}}]},'Date Saved':{date:{start:new Date().toISOString().split('T')[0]}}}});return response;}catch(error){throw error;}}app.get('/api/health',(req,res)=>{res.json({status:'ok'});});app.post('/api/save',async(req,res)=>{try{const {url,title,fileName}=req.body;if(!url){return res.status(400).json({error:'URL required'});}const contentType=detectContentType(url,fileName);const content=await extractContent(url);if(!content){return res.status(400).json({error:'Could not extract content'});}const summaryResponse=await generateSummary(content,contentType);const {summary,takeaways}=parseSummary(summaryResponse);await saveToNotion({title:title||new URL(url).hostname,url,contentType,summary,keyTakeaways:takeaways});res.json({success:true,message:`Saved to ${contentType}`,data:{title,contentType,summary,keyTakeaways:takeaways}});}catch(error){res.status(500).json({error:error.message});}});app.get('/api/database/:type',async(req,res)=>{try{const {type}=req.params;const dbId=process.env[`NOTION_${type.toUpperCase()}_DB`];if(!dbId){return res.status(404).json({error:`DB type ${type} not found`});}const database=await notion.databases.retrieve({database_id:dbId});res.json({name:database.title[0]?.plain_text||type,id:dbId,properties:Object.keys(database.properties)});}catch(error){res.status(500).json({error:error.message});}});const PORT=process.env.PORT||5000;app.listen(PORT,()=>{console.log(`SaverBot running on port ${PORT}`);});
